/**
 * This class contains unit tests for validating the behavior of Apex classes
 * and triggers.
 *
 * Unit tests are class methods that verify whether a particular piece
 * of code is working properly. Unit test methods take no arguments,
 * commit no data to the database, and are flagged with the testMethod
 * keyword in the method definition.
 *
 * All test methods in an organization are executed whenever Apex code is deployed
 * to a production organization to confirm correctness, ensure code
 * coverage, and prevent regressions. All Apex classes are
 * required to have at least 75% code coverage in order to be deployed
 * to a production organization. In addition, all triggers must have some code coverage.
 * 
 * The @isTest class annotation indicates this class only contains test
 * methods. Classes defined with the @isTest annotation do not count against
 * the organization size limit for all Apex scripts.
 *
 * See the Apex Language Reference for more information about Testing and Code Coverage.
 */
@isTest
private class CouponSellerTriggerHandlerTest {
	
	@testSetup 
    static void setup() {
    	EBH_TestDataFactory.setUpCustomSettings();   
        ActiveValidationRules__c avr = new ActiveValidationRules__c();
		avr.All_Validation_Rules_Deactivated__c = false;
		insert avr;
    }
    //static testmethod void setupData(){
        
    //}
    static testMethod void testcreateCoInvestOnceCouponSellerCreated() { 
        //setupdata();
        RecordType sellerRecordType = ApexUtil.getRecordTypeByName('Account','EBH_Seller');
    	Account acc1 = new Account(Name='Test Abc123',RecordTypeID = sellerRecordType.Id,EBH_EmailOut__c = false);
        insert acc1;
        
		RecordType couponRecordTypeItem = ApexUtil.getRecordTypeByName('Coupon__c',EBH_ConstantsUtility.COUPON_CATEGORYBASE);
        Coupon__c c1 = new Coupon__c(RecordTypeID = couponRecordTypeItem.Id, Main_Coupon_Site__c='ebay.com', Couponsite_s__c = 'ebay.com');
		insert c1;
		c1.Stage__c = EBH_ConstantsUtility.COUPON_SELLER_NEGOTIATION_STAGE;
		update c1;
		Category_Tree__c ct1 = new Category_Tree__c(Name = 'testCategoryTree1',Level__c = 0, Active__c=true);
    	insert ct1;
    	Category_Tree__c ct2 = new Category_Tree__c(Name = 'testCategoryTree2',Level__c = 1,Note_ID__c=ct1.Id,Active__c=true);
    	insert ct2;
    	Coupon_Category__c cc1 = new Coupon_Category__c(Coupon__c = c1.Id,Category__c = ct1.Id);
    	Coupon_Category__c cc2 = new Coupon_Category__c(Coupon__c = c1.Id,Category__c = ct2.Id);
    	insert new List<Coupon_Category__c>{cc1,cc2};
    	
		Test.startTest();
		/*UploadController.mapCsSellerShare.put(1, '34.2');
		UploadController.mapCsSellerShare.put(2, '34.2');
		UploadController.mapCsSellerShare.put(3, '34.2');
		UploadController.mapCsSellerShare.put(4, '34.2');
		UploadController.mapCsSellerShare.put(5, '34.2');*/
		Coupon_Seller__c cs1 = new Coupon_Seller__c(Coupon__c = c1.Id,Coupon_Seller_Stage__c=EBH_ConstantsUtility.COUPON_SELLER_STAGE_NEGO);
		insert cs1;
		
        Test.stopTest();
        Coupon_Co_Invest__c[] cciSel = [select Id,RecordType.DeveloperName,Coupon_Category__c From Coupon_Co_Invest__c Where Coupon_Name__c =: c1.Id];
        System.assertEquals(2,cciSel.size(),' 2 Co-Invest created');
        for(Coupon_Co_Invest__c coInvest : cciSel){
    		if(coInvest.Coupon_Category__c == cc1.Id){
    			System.assertEquals(EBH_ConstantsUtility.CO_INVEST_SELLER, coInvest.RecordType.DeveloperName, 'Rule i : Coupon Co-Invest Seller when Coupon Object Record type: Seller/Category based and Coupon Stage in "Seller Negotiation" and Coupon Level = 0');
    		}else if(coInvest.Coupon_Category__c == cc2.Id){
    			System.assertEquals(EBH_ConstantsUtility.CO_INVEST_CATEGORY, coInvest.RecordType.DeveloperName, 'Rule ii : Coupon Co-Invest Category when Coupon Object Record type: Seller/Category based and Coupon Stage in "Seller Negotiation" and Coupon Level > 0');
    		}
    	}
    }
    
    static testMethod void testCreateCoInvest2() {
         //setupdata();
    	RecordType sellerRecordType = ApexUtil.getRecordTypeByName('Account','EBH_Seller');
    	Account acc1 = new Account(Name='Test Abc123',RecordTypeID = sellerRecordType.Id,EBH_EmailOut__c = false);
        insert acc1;
        RecordType couponRecordTypeItem = ApexUtil.getRecordTypeByName('Coupon__c',EBH_ConstantsUtility.COUPON_ITEMBASE);
        Coupon__c c1 = new Coupon__c(RecordTypeID = couponRecordTypeItem.Id,Contract_Due_Date__c = System.today(), Main_Coupon_Site__c='ebay.com', Couponsite_s__c = 'ebay.com');
		insert c1;
		
		Coupon_Seller__c cs1 = new Coupon_Seller__c(Coupon__c = c1.Id,Coupon_Seller_Stage__c='Targeted');
		insert cs1;
		
		Coupon_Item__c ci = new Coupon_Item__c(Coupon_ID__c=c1.Id, Coupon_Seller_ID__c=cs1.Id,Item_ID__c='1234567890',Seller_Share__c=10);
		insert ci;
		Test.startTest();
			cs1.Coupon_Seller_Stage__c = EBH_ConstantsUtility.COUPON_SELLER_STAGE_NEGO;
			update cs1;
		Test.stopTest();
		System.assertEquals(EBH_ConstantsUtility.CO_INVEST_ITEM,[select Id,RecordType.DeveloperName From Coupon_Co_Invest__c Where Coupon_Seller__c = :cs1.Id].RecordType.DeveloperName,' 1 Co-Invest created with Coupon_Co_Invest_Item record type');
    }
    
    static testMethod void testSendContract()
    {
    	//Set<String> excludeUser = new Set<String>{'Integration','Deployment'}; //by pass validation rule
    	User admin1 = EBH_TestDataFactory.createUser('System Administrator');
    	admin1.FirstName = 'Test';//by pass validation rule
    	//User admin1 = [Select Id,Name From User where isActive = true and Profile.Name = 'System Administrator' AND Name NOT IN :excludeUser Limit 1 ];
    	System.runAs(admin1)
    	{
	        //setupdata();
	    	// EBH_TestDataFactory.setUpCustomSettings();
	    	RecordType sellerRecordType = ApexUtil.getRecordTypeByName('Account','EBH_Seller');
	    	Account acc1 = new Account(Name='Test Abc123',RecordTypeID = sellerRecordType.Id,EBH_DealsProgram__c='Accepted',EBH_EmailOut__c = false);
	        insert acc1;
			
			Account acc2 = new Account(Name='Test Abc2',RecordTypeID = sellerRecordType.Id, EBH_DealsProgram__c='Accepted',EBH_EmailOut__c = false);
	        insert acc2;

			Contact con1 = new Contact(LastName='Test Con1', Email='test1@test.com.invalid', AccountId=acc1.Id); //MN-30082021-US-0009948
			Contact con2 = new Contact(LastName='Test Con2', Email='test2@test.com.invalid', AccountId=acc2.Id); //MN-30082021-US-0009948
        	insert new List<Contact>{con1, con2}; //MN-30082021-US-0009948
			
	        RecordType couponRecordTypeItem = ApexUtil.getRecordTypeByName('Coupon__c',EBH_ConstantsUtility.COUPON_ITEMBASE);
	        Coupon__c c1 = new Coupon__c(RecordTypeID = couponRecordTypeItem.Id,Coupon_Start_Date__c = System.today(),Coupon_End_Date__c=System.today(),Contract_Language__c = 'DE',Contract_Due_Date__c = System.today()-1, Main_Coupon_Site__c='ebay.com', Couponsite_s__c = 'ebay.com');
			insert c1;
			
			//Coupon_Seller__c cs1 = new Coupon_Seller__c(Coupon__c = c1.Id,Coupon_Seller_Stage__c='Targeted',Email_Adress__c='test@test.com',EBH_CouponSellerOwner__c = UserInfo.getUserId(),Seller__c = acc2.Id); //MN-30082021-US-0009948
			Coupon_Seller__c cs1 = new Coupon_Seller__c(Coupon__c = c1.Id,Coupon_Seller_Stage__c='Targeted',Seller_Contact__c =  con2.Id,EBH_CouponSellerOwner__c = UserInfo.getUserId(),Seller__c = acc2.Id); //MN-30082021-US-0009948
			insert cs1;
			
			Coupon_Item__c ci = new Coupon_Item__c(Coupon_ID__c=c1.Id, Coupon_Seller_ID__c=cs1.Id,Item_ID__c='1234567890',Seller_Share__c=10);
			insert ci;
			
			cs1.Coupon_Seller_Stage__c = EBH_ConstantsUtility.COUPON_SELLER_STAGE_NEGO;
			update cs1;
			
			
			cs1.Legal_Entity_Name_w__c = 'test entity';
			cs1.Legal_Entity_Street_w__c = 'test street';
			cs1.Legal_Entity_Zip_w__c = 'test zip';
			cs1.Coupon_Seller_Stage__c = EBH_ConstantsUtility.COUPON_SELLER_STAGE_CONTRACT_SEND ;
			update cs1;
			Test.startTest();
				//Coupon_Seller__c cs2 = new Coupon_Seller__c(Email_Adress__c='test2@test.com',Coupon__c = c1.Id, Seller__c = acc1.Id, Coupon_Seller_Stage__c=EBH_ConstantsUtility.COUPON_SELLER_STAGE_CONTRACT_SEND); //MN-30082021-US-0009948
				Coupon_Seller__c cs2 = new Coupon_Seller__c(Seller_Contact__c =  con1.Id,Coupon__c = c1.Id, Seller__c = acc1.Id, Coupon_Seller_Stage__c=EBH_ConstantsUtility.COUPON_SELLER_STAGE_CONTRACT_SEND); //MN-30082021-US-0009948
				try{
					insert cs2;
				}catch(Exception e){
					System.assert(e.getMessage().contains(system.label.error_CouponItem_notExist));
				}
				
				cs2.Coupon_Seller_Stage__c = 'Targeted';
				insert cs2;
				Coupon_Item__c ci2 = new Coupon_Item__c(Coupon_ID__c=c1.Id, Coupon_Seller_ID__c=cs2.Id,Item_ID__c='1234567892',Seller_Share__c=10);
				insert ci2;
				cs2.Coupon_Seller_Stage__c = EBH_ConstantsUtility.COUPON_SELLER_STAGE_NEGO;
				update cs2;
				cs2.Legal_Entity_Name_w__c = 'test entity';
				cs2.Legal_Entity_Street_w__c = 'test street';
				cs2.Legal_Entity_Zip_w__c = 'test zip';
				cs2.Coupon_Seller_Stage__c = EBH_ConstantsUtility.COUPON_SELLER_STAGE_CONTRACT_SEND ;
				update cs2;
			Test.stopTest();
			List<Task> lstTask = [select Id from Task where WhatId =: cs1.Id];
			System.assertEquals(1,lstTask.size());
			List<Attachment> lsttaskAtt = [select id,Name from Attachment where ParentId =: lstTask[0].id];
			System.assertEquals(2,lsttaskAtt.size());
			List<Task> lstTask2 = [select Id from Task where WhatId =: cs2.Id];
			System.assertEquals(1,lstTask2.size());
			
			cs1.Coupon_Seller_Stage__c = EBH_ConstantsUtility.COUPON_SELLER_STAGE_EXEC;
			cs1.Day4AfterCouponEnd_Trigger_DE__c = System.now();
			cs1.Contract_Accept_Date__c = System.now();
			update cs1;
			
			cs1.Day34AfterCouponEnd_Trigger_DE__c = System.now();
			cs1.Coupon_Seller_Stage__c = EBH_ConstantsUtility.COUPON_SELLER_STAGE_T4;
			update cs1;
    	}
    }
	
	static testMethod void testsetEmailAddress(){
         //setupdata();
    	RecordType sellerRecordType = ApexUtil.getRecordTypeByName('Account','EBH_Seller');
    	RecordType ContactRecordType = ApexUtil.getRecordTypeByName('Contact',EBH_ConstantsUtility.CONTACT_RECORDTYPE_DWH);
    	Account acc1 = new Account(Name='Test Acc1',RecordTypeID = sellerRecordType.Id,EBH_EmailOut__c = false);
    	Account acc2 = new Account(Name='Test Acc2',RecordTypeID = sellerRecordType.Id,EBH_EmailOut__c = false);
        insert new List<Account>{acc1,acc2};
        Contact con = new Contact(LastName = 'testContact1', AccountId = acc1.Id, EBH_Status__c='Active',Email='test1@gmail.com',
    	Phone='123456',EBH_MailingStreet__c='testMailingStreet',EBH_MailingPostalCode__c='testMailingPostalcode',
    	EBH_MailingCountry__c='testMailingCountry',EBH_MailingCity__c='testMailingCity',EBH_MailingAddress__c='testMailingAddress',EBH_Decision_Maker_Role__c=EBH_ConstantsUtility.DECISION_MAKER_ROLE);
    	Contact con2 = new Contact(LastName = 'testContact2', AccountId = acc1.Id, EBH_Status__c='Active',Email='test2@gmail.com',
    	Phone='123457',EBH_MailingStreet__c='testMailingStreet',EBH_MailingPostalCode__c='testMailingPostalcode',
    	EBH_MailingCountry__c='testMailingCountry',EBH_MailingCity__c='testMailingCity',EBH_MailingAddress__c='testMailingAddress',RecordTypeId=ContactRecordType.Id);
    	Contact con3 = new Contact(LastName = 'testContact3', AccountId = acc2.Id, EBH_Status__c='Active',Email='test3@gmail.com',
    	Phone='123458',EBH_MailingStreet__c='testMailingStreet',EBH_MailingPostalCode__c='testMailingPostalcode',
    	EBH_MailingCountry__c='testMailingCountry',EBH_MailingCity__c='testMailingCity',EBH_MailingAddress__c='testMailingAddress',RecordTypeId=ContactRecordType.Id);
    	insert new List<Contact>{con,con2,con3};
    	Coupon__c c1 = new Coupon__c(Main_Coupon_Site__c='ebay.com', Couponsite_s__c = 'ebay.com');
		insert c1;
    	Coupon_Seller__c cs1 = new Coupon_Seller__c(Coupon__c = c1.Id,Coupon_Seller_Stage__c='Targeted',Seller__c=acc1.Id);
    	Coupon_Seller__c cs2 = new Coupon_Seller__c(Coupon__c = c1.Id,Coupon_Seller_Stage__c='Targeted',Seller__c=acc2.Id);
    	Test.startTest();
    	insert new List<Coupon_Seller__c>{cs1,cs2};
    	Test.stopTest();
    	/* //MN-30082021-US-0009948
		System.assertEquals(con.Email,[select Email_Adress__c from Coupon_Seller__c where id =: cs1.Id].Email_Adress__c);
    	System.assertEquals(con3.Email,[select Email_Adress__c from Coupon_Seller__c where id =: cs2.Id].Email_Adress__c);
		*/

		System.assertEquals(con.Id,[select Seller_Contact__c from Coupon_Seller__c where id =: cs1.Id].Seller_Contact__c); //MN-30082021-US-0009948
    	System.assertEquals(con3.Id,[select Seller_Contact__c from Coupon_Seller__c where id =: cs2.Id].Seller_Contact__c); //MN-30082021-US-0009948
    }
	
	static testMethod void testPrepopulateOwnerFromSeller(){
        //setupData();
    	Test.startTest();
    	
	    	RecordType sellerRecordType = ApexUtil.getRecordTypeByName('Account','EBH_Seller');
	    	Account acc1 = new Account(Name='Test Acc1',RecordTypeID = sellerRecordType.Id,EBH_EmailOut__c = false);
	    	insert acc1;
	    	Coupon__c c1 = new Coupon__c(Main_Coupon_Site__c='ebay.com', Couponsite_s__c = 'ebay.com');
			insert c1;
	    	Coupon_Seller__c cs1 = new Coupon_Seller__c(Coupon__c = c1.Id,Coupon_Seller_Stage__c='Targeted',Seller__c=acc1.Id);
	    	insert cs1;
	    	cs1 = [SELECT EBH_CouponSellerOwner__c FROM Coupon_Seller__c WHERE Id =: cs1.Id];
	    	acc1 = [SELECT OwnerId FROM Account WHERE Id =: acc1.Id];
	    	System.assertEquals(cs1.EBH_CouponSellerOwner__c, acc1.OwnerId);
    	
    	Test.stopTest();
    }
    
    
    static testMethod void testblockManualSetStageWhenCreate(){
         //setupdata();
    		RecordType sellerRecordType = ApexUtil.getRecordTypeByName('Account','EBH_Seller');
    		Account acc1 = new Account(Name='Test Acc1',RecordTypeID = sellerRecordType.Id,EBH_EmailOut__c = false);
    		insert acc1;
    		Coupon__c c1 = new Coupon__c(Main_Coupon_Site__c='ebay.com', Couponsite_s__c = 'ebay.com');
			insert c1;
    		Test.startTest();
    		try {
    			Coupon_Seller__c cs1 = new Coupon_Seller__c(Coupon__c = c1.Id,Coupon_Seller_Stage__c='Contract Signed',Seller__c=acc1.Id);
	    		insert cs1;
        	}catch(Exception e) {
        		System.assert(e.getMessage().contains(EBH_ConstantsUtility.COUPON_SELLER_ERROR_MSG));
        	}
    		Test.stopTest();
    //	}
    	
    }
    
    static testMethod void testblockManualSetStageWhenUpdated(){
         //setupdata();
    		RecordType sellerRecordType = ApexUtil.getRecordTypeByName('Account','EBH_Seller');
    		Account acc1 = new Account(Name='Test Acc1',RecordTypeID = sellerRecordType.Id,EBH_EmailOut__c = false);
    		insert acc1;
    		Coupon__c c1 = new Coupon__c(Main_Coupon_Site__c='ebay.com', Couponsite_s__c = 'ebay.com');
			insert c1;
			Coupon_Seller__c cs1 = new Coupon_Seller__c(Coupon__c = c1.Id,Coupon_Seller_Stage__c='Targeted',Seller__c=acc1.Id);
	    	insert cs1;
    		Test.startTest();
    		try {
				cs1.Coupon_Seller_Stage__c = 'Coupon Running';
				update c1;
        	}catch(Exception e) {
        		System.assert(e.getMessage().contains(EBH_ConstantsUtility.COUPON_SELLER_ERROR_MSG));
        	}
    		Test.stopTest();
    	//} Commented by DHE
    }
    
    static testMethod void testcouponSellerContractReminderAU(){
    	//setupdata();
    	User auUser1 = EBH_TestDataFactory.createUser(EBH_ConstantsUtility.TICKET_AU_PROFILE);
        User auUser2 = EBH_TestDataFactory.createUser(EBH_ConstantsUtility.TICKET_AU_PROFILE);
        insert new List<User>{auUser1,auUser2};
        System.runAs(auUser2){
            PermissionSet ps = [SELECT Id FROM PermissionSet WHERE Name =: EBH_ConstantsUtility.PERMISSION_COUPONSPECIALPERMISSION];
            PermissionSetAssignment pmm = new PermissionSetAssignment(AssigneeId = auUser1.id, PermissionSetId = ps.Id);
            insert pmm;
        }
    	System.runAs(auUser1)
    	{
	    	// EBH_TestDataFactory.setUpCustomSettings();
	    	RecordType sellerRecordType = ApexUtil.getRecordTypeByName('Account','EBH_Seller');
	    	Account acc1 = new Account(Name='Test Abc123',RecordTypeID = sellerRecordType.Id,EBH_DealsProgram__c='Accepted',EBH_EmailOut__c = false);
	        insert acc1;
			
			Account acc2 = new Account(Name='Test Abc2',RecordTypeID = sellerRecordType.Id, EBH_DealsProgram__c='Accepted',EBH_EmailOut__c = false);
	        insert acc2;

			Contact con1 = new Contact(LastName='Test Con1', Email='test1@test.com.invalid', AccountId=acc1.Id); //MN-30082021-US-0009948
			Contact con2 = new Contact(LastName='Test Con2', Email='test2@test.com.invalid', AccountId=acc2.Id); //MN-30082021-US-0009948
        	insert new List<Contact>{con1, con2}; //MN-30082021-US-0009948
			
	        RecordType couponRecordTypeItem = ApexUtil.getRecordTypeByName('Coupon__c',EBH_ConstantsUtility.COUPON_ITEMBASE);
	        Coupon__c c1 = new Coupon__c(RecordTypeID = couponRecordTypeItem.Id,Coupon_Start_Date__c = System.today()+3,Coupon_End_Date__c=System.today()+7,Contract_Language__c = 'AU',Contract_Due_Date__c = System.today()+1, Main_Coupon_Site__c='ebay.com', Couponsite_s__c = 'ebay.com');
			insert c1;
			
			//Coupon_Seller__c cs1 = new Coupon_Seller__c(Coupon__c = c1.Id,Contract_Accept_Date__c = null,Coupon_Seller_Stage__c='Targeted',Email_Adress__c='test@test.com',EBH_CouponSellerOwner__c = UserInfo.getUserId()); //MN-30082021-US-0009948
			Coupon_Seller__c cs1 = new Coupon_Seller__c(Coupon__c = c1.Id,Contract_Accept_Date__c = null,Coupon_Seller_Stage__c='Targeted',Seller__c = acc2.Id, Seller_Contact__c=con2.Id,EBH_CouponSellerOwner__c = UserInfo.getUserId()); //MN-30082021-US-0009948
			insert cs1;
			
			Coupon_Item__c ci = new Coupon_Item__c(Coupon_ID__c=c1.Id, Coupon_Seller_ID__c=cs1.Id,Item_ID__c='1234567890',Seller_Share__c=10);
			insert ci;
			
			cs1.Coupon_Seller_Stage__c = EBH_ConstantsUtility.COUPON_SELLER_STAGE_NEGO;
			update cs1;
			cs1.Coupon_Seller_Stage__c = EBH_ConstantsUtility.COUPONSELLER_STAGE_APPROVED;
			update cs1;
			Test.startTest();
			
			cs1.Seller__c = acc2.Id;
			update cs1;

			cs1.Legal_Entity_Name_w__c = 'test entity';
			cs1.Legal_Entity_Street_w__c = 'test street';
			cs1.Legal_Entity_Zip_w__c = 'test zip';
			cs1.Coupon_Seller_Stage__c = EBH_ConstantsUtility.COUPON_SELLER_STAGE_CONTRACT_SEND ;
			update cs1;
			
			//Coupon_Seller__c cs2 = new Coupon_Seller__c(Email_Adress__c='test2@test.com',Coupon__c = c1.Id, Seller__c = acc1.Id, Coupon_Seller_Stage__c=EBH_ConstantsUtility.COUPON_SELLER_STAGE_CONTRACT_SEND);
			Coupon_Seller__c cs2 = new Coupon_Seller__c(Seller_Contact__c=con1.Id,Coupon__c = c1.Id, Seller__c = acc1.Id, Coupon_Seller_Stage__c=EBH_ConstantsUtility.COUPON_SELLER_STAGE_CONTRACT_SEND);
			try{
				insert cs2;
			}catch(Exception e){
				System.assert(e.getMessage().contains(system.label.error_CouponItem_notExist));
			}
			
			cs2.Coupon_Seller_Stage__c = 'Targeted';
			insert cs2;
			Coupon_Item__c ci2 = new Coupon_Item__c(Coupon_ID__c=c1.Id, Coupon_Seller_ID__c=cs2.Id,Item_ID__c='1234567892',Seller_Share__c=10);
			insert ci2;
			cs2.Coupon_Seller_Stage__c = EBH_ConstantsUtility.COUPON_SELLER_STAGE_NEGO;
			update cs2;
			cs2.Coupon_Seller_Stage__c = 'Approved';
			update cs2;
			cs2.Legal_Entity_Name_w__c = 'test entity';
			cs2.Legal_Entity_Street_w__c = 'test street';
			cs2.Legal_Entity_Zip_w__c = 'test zip';
			cs2.Coupon_Seller_Stage__c = EBH_ConstantsUtility.COUPON_SELLER_STAGE_CONTRACT_SEND ;
			update cs2;
			
			Test.stopTest();
			List<Task> lstTask = [select Id from Task where WhatId =: cs1.Id];
			System.assertEquals(1,lstTask.size());
			
			//List<Task> lstTask2 = [select Id from Task where WhatId =: cs2.Id];
			//System.assertEquals(3,lstTask2.size());
				
    	}
    	 
	}
	
	
	@isTest 
	private static void testValidateCoInv_SellerShareAndCompanyDetail(){
		//setupdata();
		User admin1 = EBH_TestDataFactory.createUser('System Administrator');
    	admin1.FirstName = 'Test';
    	System.runAs(admin1)
    	{
		Test.startTest();
			RecordType sellerRecordType = ApexUtil.getRecordTypeByName('Account','EBH_Seller');
			Account acc = new Account(Name='Test Acc1',RecordTypeID = sellerRecordType.Id,EBH_DealsProgram__c='Accepted',EBH_EmailOut__c = false);
			insert acc;

			Coupon__c c1 = new Coupon__c(Seller_Co_funding_share_forecast__c = null,Coupon_Start_Date__c = System.today(),Coupon_End_Date__c = System.today().addDays(1), Negotiation_End_Date__c=System.today().addDays(1), Contract_Due_Date__c = System.today().addDays(-1), Main_Coupon_Site__c='ebay.com', Couponsite_s__c = 'ebay.com');
			insert c1;

			Coupon_Seller__c cs1 = new Coupon_Seller__c(Coupon__c = c1.Id,seller__c = acc.Id,Legal_Entity_Name_w__c = 'testName',Legal_Entity_Street_w__c='testStreet',Legal_Entity_Zip_w__c='testZip');
			insert cs1;
			
			Coupon_Co_Invest__c coInvest = new Coupon_Co_Invest__c(Coupon_Seller__c=cs1.Id,Seller_Name__c=acc.Id,Coupon_Name__c=c1.Id,Co_Invest__c=null);
			insert coInvest;
			
			// AC1)
			try {
				cs1.Coupon_Seller_Stage__c = EBH_ConstantsUtility.COUPON_SELLER_STAGE_CONTRACT_SEND;
				update cs1;
				//System.assert(false);
			} catch (Exception ex) {
				System.assert(ex.getMessage().contains(Label.CouponSellerStageContractSend_Error2), ex.getMessage());
			}

			coInvest.Co_Invest__c = 10;
			update coInvest;

			// AC2)
			try {
				update cs1;
				//System.assert(false);
			} catch (Exception ex) {
				System.assert(ex.getMessage().contains('Seller Share value on related Co-Invest Records, Company, Street and ZIP cannot be empty'), ex.getMessage());
			}

			try {
				cs1.Legal_Entity_Name_w__c = 'test entity';
				cs1.Legal_Entity_Street_w__c = 'test street';
				cs1.Legal_Entity_Zip_w__c = 'test zip';
				update cs1;
				
			} catch (Exception ex) {
				System.assert(false, ex.getMessage());
			}
			
			// Should be success
			try {
				update cs1;
			} catch (Exception ex) {
				System.assert(false, ex.getMessage());
			}
			
		Test.stopTest();
    	}
	}
    
	//commented by DHE on 2020-09-02 because of us-0008187
	//uncommented by Ratha Sim on 2020-09-09 because of US-0008170
	static testMethod void testSendCouponLaunchReminderTemplates(){
		User admin1 = EBH_TestDataFactory.createUser('System Administrator');
		admin1.FirstName = 'Test';
		System.runAs(admin1)
		{
			//setupdata();
			RecordType sellerRecordType = ApexUtil.getRecordTypeByName('Account','EBH_Seller');
			Account acc1 = new Account(Name='Test Abc1',RecordTypeID = sellerRecordType.Id,EBH_DealsProgram__c='Accepted',EBH_EmailOut__c = false);
			insert acc1;

			Contact con = new Contact(LastName='Test Con1', Email='test@test.com.invalid', AccountId=acc1.Id); //MN-30082021-US-0009948
        	insert con; //MN-30082021-US-0009948
			
			RecordType couponRecordTypeItem = ApexUtil.getRecordTypeByName('Coupon__c',EBH_ConstantsUtility.COUPON_ITEMBASE);
			Coupon__c c1 = new Coupon__c(RecordTypeID = couponRecordTypeItem.Id,Coupon_Start_Date__c = System.today(),Coupon_End_Date__c=System.today(),Contract_Language__c = 'UK',Contract_Due_Date__c = System.today()-1, Main_Coupon_Site__c='ebay.com', Couponsite_s__c = 'ebay.com');//SB 8.11.2021 US-0010476 add contract due date value to coupon
			insert c1;
			
			RecordType manhattanCouponSellerRecordType = ApexUtil.getRecordTypeByName('Coupon_Seller__c',EBH_ConstantsUtility.COUPONSELLER_MANHATTAN_RECORDTYPE);
			//Coupon_Seller__c cs1 = new Coupon_Seller__c(Coupon__c = c1.Id,Coupon_Seller_Stage__c='Targeted',Email_Adress__c='test@test.com',EBH_CouponSellerOwner__c = UserInfo.getUserId(),Seller__c = acc1.Id,RecordTypeID=manhattanCouponSellerRecordType.Id); //MN-30082021-US-0009948
			Coupon_Seller__c cs1 = new Coupon_Seller__c(Coupon__c = c1.Id,Coupon_Seller_Stage__c='Targeted',Seller_Contact__c=con.Id,EBH_CouponSellerOwner__c = UserInfo.getUserId(),Seller__c = acc1.Id,RecordTypeID=manhattanCouponSellerRecordType.Id); //MN-30082021-US-0009948
			insert cs1;

			Coupon_Co_Invest__c coInvest = new Coupon_Co_Invest__c(Coupon_Seller__c=cs1.Id,Seller_Name__c=acc1.Id,Coupon_Name__c=c1.Id,Co_Invest__c=10);
			insert coInvest;
			
			Test.startTest();
				cs1.UK_Coupon_Launch_Reminder_Date__c = System.now();
				update cs1;
			Test.stopTest();
			for(Task task : [select Id from Task where WhatId =: cs1.Id]){
				List<Attachment> lsttaskAtt = [select id,Name from Attachment where ParentId =: task.id];
				System.assertEquals(2,lsttaskAtt.size());
			}
			
		}
	}	
	
	static testMethod void testsendCpnAcceptOfCpnContr(){
		User admin1 = EBH_TestDataFactory.createUser('System Administrator');
    	admin1.FirstName = 'Test';
    	System.runAs(admin1)
    	{
    		//setupdata();
    		RecordType sellerRecordType = ApexUtil.getRecordTypeByName('Account','EBH_Seller');
	    	Account acc1 = new Account(Name='Test Abc1',RecordTypeID = sellerRecordType.Id,EBH_DealsProgram__c='Accepted',EBH_EmailOut__c = false);
	        insert acc1;

			Contact con = new Contact(LastName='Test Con1', Email='test@test.com.invalid', AccountId=acc1.Id); //MN-30082021-US-0009948
        	insert con; //MN-30082021-US-0009948
	        
	    	RecordType couponRecordTypeItem = ApexUtil.getRecordTypeByName('Coupon__c',EBH_ConstantsUtility.COUPON_ITEMBASE);
	        Coupon__c c1 = new Coupon__c(RecordTypeID = couponRecordTypeItem.Id,Coupon_Start_Date__c = System.today(),Coupon_End_Date__c=System.today(),Contract_Language__c = 'AU',Contract_Due_Date__c = System.today()-1, Main_Coupon_Site__c='ebay.com', Couponsite_s__c = 'ebay.com');
			insert c1;
			
			RecordType manhattanCouponSellerRecordType = ApexUtil.getRecordTypeByName('Coupon_Seller__c',EBH_ConstantsUtility.COUPONSELLER_MANHATTAN_RECORDTYPE);
			//Coupon_Seller__c cs1 = new Coupon_Seller__c(Coupon__c = c1.Id,Coupon_Seller_Stage__c='Targeted',Email_Adress__c='test@test.com',EBH_CouponSellerOwner__c = UserInfo.getUserId(),Seller__c = acc1.Id,RecordTypeID=manhattanCouponSellerRecordType.Id); //MN-30082021-US-0009948
			Coupon_Seller__c cs1 = new Coupon_Seller__c(Coupon__c = c1.Id,Coupon_Seller_Stage__c='Targeted',Seller_Contact__c=con.Id,EBH_CouponSellerOwner__c = UserInfo.getUserId(),Seller__c = acc1.Id,RecordTypeID=manhattanCouponSellerRecordType.Id); //MN-30082021-US-0009948
			insert cs1;
    
			Coupon_Co_Invest__c coInvest = new Coupon_Co_Invest__c(Coupon_Seller__c=cs1.Id,Seller_Name__c=acc1.Id,Coupon_Name__c=c1.Id,Co_Invest__c=10);
			insert coInvest;
			
			Test.startTest();
				cs1.Coupon_Seller_Stage__c = 'Contract Signed';
				update cs1;
			Test.stopTest();
			List<Task> lstTask = [select Id from Task where WhatId =: cs1.Id];
			System.assertEquals(1,lstTask.size());
			
    	}
	}

	@isTest
	static void test_preventRecordDeletion(){
		User admin1 = EBH_TestDataFactory.createUser('System Administrator');
    	admin1.FirstName = 'Test';
    	System.runAs(admin1)
    	{
    		//setupdata();
    		RecordType sellerRecordType = ApexUtil.getRecordTypeByName('Account','EBH_Seller');
	    	Account acc1 = new Account(Name='Test Abc1',RecordTypeID = sellerRecordType.Id,EBH_DealsProgram__c='Accepted',EBH_EmailOut__c = false);
	        insert acc1;
	        
			Contact con = new Contact(LastName='Test Con1', Email='test@test.com.invalid', AccountId=acc1.Id); //MN-30082021-US-0009948
        	insert con; //MN-30082021-US-0009948

	    	RecordType itemBasedCouponRecordTypeItem = ApexUtil.getRecordTypeByName('Coupon__c', CouponSellerTriggerHandler.COUPON_ITEMBASE); // Change history: 16.03.2022 / Chetra Sarom / 16.03.2022 / US-0010643 
			RecordType popCouponRecordTypeItem = ApexUtil.getRecordTypeByName('Coupon__c', CouponSellerTriggerHandler.POP_COUPON); // Chetra Sarom / 16.03.2022 / US-0010643

	        Coupon__c c1 = new Coupon__c(Stage__c = 'Draft', RecordTypeID = itemBasedCouponRecordTypeItem.Id,Coupon_Start_Date__c = System.today(),Coupon_End_Date__c=System.today(),Contract_Language__c = 'AU',Contract_Due_Date__c = System.today()-1, Main_Coupon_Site__c='ebay.com', Couponsite_s__c = 'ebay.com');
			Coupon__c c2 = new Coupon__c(Stage__c = 'Coupon Running', RecordTypeID = itemBasedCouponRecordTypeItem.Id,Coupon_Start_Date__c = System.today(),Coupon_End_Date__c=System.today(),Contract_Language__c = 'AU',Contract_Due_Date__c = System.today()-1, Main_Coupon_Site__c='ebay.com', Couponsite_s__c = 'ebay.com');
			Coupon__c c3 = new Coupon__c(Stage__c = 'Coupon Running', RecordTypeID = popCouponRecordTypeItem.Id,Coupon_Start_Date__c = System.today(),Coupon_End_Date__c=System.today(),Contract_Language__c = 'AU',Contract_Due_Date__c = System.today()-1, Main_Coupon_Site__c='ebay.com', Couponsite_s__c = 'ebay.com'); // Chetra Sarom / 16.03.2022 / US-0010643
			insert new List<Coupon__c>{c1,c2,c3};
			
			RecordType manhattanCouponSellerRecordType = ApexUtil.getRecordTypeByName('Coupon_Seller__c',CouponSellerTriggerHandler.COUPONSELLER_MANHATTAN_RECORDTYPE);
			RecordType couponPopCouponSellerRecordType = ApexUtil.getRecordTypeByName('Coupon_Seller__c',CouponSellerTriggerHandler.COUPON_POP_RECORDTYPE); // Chetra Sarom / 16.03.2022 / US-0010643
			// Coupon_Seller__c cs1 = new Coupon_Seller__c(Coupon__c = c1.Id,Coupon_Seller_Stage__c='T4 Statement Send',Email_Adress__c='test@test.com',EBH_CouponSellerOwner__c = UserInfo.getUserId(),Seller__c = acc1.Id,RecordTypeID=manhattanCouponSellerRecordType.Id); //MN-30082021-US-0009948
			// Coupon_Seller__c cs2 = new Coupon_Seller__c(Coupon__c = c2.Id,Coupon_Seller_Stage__c='Targeted',Email_Adress__c='test1@test.com',EBH_CouponSellerOwner__c = UserInfo.getUserId(),Seller__c = acc1.Id,RecordTypeID=manhattanCouponSellerRecordType.Id); //MN-30082021-US-0009948
			Coupon_Seller__c cs1 = new Coupon_Seller__c(Coupon__c = c1.Id,Coupon_Seller_Stage__c='T4 Statement Send',Seller_Contact__c=con.Id,EBH_CouponSellerOwner__c = UserInfo.getUserId(),Seller__c = acc1.Id,RecordTypeID=manhattanCouponSellerRecordType.Id); //MN-30082021-US-0009948
			Coupon_Seller__c cs2 = new Coupon_Seller__c(Coupon__c = c2.Id,Coupon_Seller_Stage__c='Targeted',Seller_Contact__c=con.Id,EBH_CouponSellerOwner__c = UserInfo.getUserId(),Seller__c = acc1.Id,RecordTypeID=manhattanCouponSellerRecordType.Id); //MN-30082021-US-0009948
			Coupon_Seller__c cs3 = new Coupon_Seller__c(Coupon__c = c3.Id,Coupon_Seller_Stage__c='New',Seller_Contact__c=con.Id,EBH_CouponSellerOwner__c = UserInfo.getUserId(),Seller__c = acc1.Id,RecordTypeID=couponPopCouponSellerRecordType.Id); // Chetra Sarom / 16.03.2022 / US-0010643
			insert new List<Coupon_Seller__c>{cs1,cs2,cs3};
    
			Test.startTest();
				//error in 1st filtering
				try {

					delete cs1;

				}catch(Exception ex) {
					//System.assert(ex.getMessage().contains(System.Label.Prevent_Deletion_of_Coupon_Seller));
				}

				//error in 2nd filtering
				try {

					delete cs2;

				}catch(Exception ex) {
					System.assert(ex.getMessage().contains(System.Label.Prevent_Deletion_of_Coupon_Seller));
				}

				// Chetra Sarom / 16.03.2022 / US-0010643 
				try {

					delete cs3;

				}catch(Exception ex) {
					System.assert(ex.getMessage().contains(System.Label.Prevent_Deletion_of_Pop_Coupon_Seller));
				}
				// US-0010643 END

			Test.stopTest();
			
			
    	}
	}
	@isTest
	static void test_addFileAttachment(){
		User admin1 = EBH_TestDataFactory.createUser('System Administrator');
    	admin1.FirstName = 'Test';
    	System.runAs(admin1)
    	{
    		RecordType sellerRecordType = ApexUtil.getRecordTypeByName('Account','EBH_Seller');
	    	Account acc1 = new Account(Name='Test Abc1',RecordTypeID = sellerRecordType.Id,EBH_DealsProgram__c='Accepted',EBH_EmailOut__c = false);
	        insert acc1;
	        
			Contact con = new Contact(LastName='Test Con1', Email='test@test.com.invalid', AccountId=acc1.Id); //MN-30082021-US-0009948
        	insert con;

	    	RecordType couponRecordTypeItem = ApexUtil.getRecordTypeByName('Coupon__c',EBH_ConstantsUtility.COUPON_ITEMBASE);
	        Coupon__c c1 = new Coupon__c(MC_Whitelisted__c = true,Stage__c = 'Draft', RecordTypeID = couponRecordTypeItem.Id,Coupon_Start_Date__c = System.today(),Coupon_End_Date__c=System.today(),Contract_Language__c = 'UK',Contract_Due_Date__c = System.today()-1, Main_Coupon_Site__c='ebay.com', Couponsite_s__c = 'ebay.com');
			insert new List<Coupon__c>{c1};
			
			RecordType manhattanCouponSellerRecordType = ApexUtil.getRecordTypeByName('Coupon_Seller__c',EBH_ConstantsUtility.COUPONSELLER_MANHATTAN_RECORDTYPE);
			Coupon_Seller__c cs1 = new Coupon_Seller__c(Coupon__c = c1.Id,Coupon_Seller_Stage__c='Targeted',Seller_Contact__c=con.Id,EBH_CouponSellerOwner__c = UserInfo.getUserId(),Seller__c = acc1.Id,RecordTypeID=manhattanCouponSellerRecordType.Id); //MN-30082021-US-0009948
			insert new List<Coupon_Seller__c>{cs1};
			
			Coupon_Co_Invest__c coInvest = new Coupon_Co_Invest__c(Coupon_Seller__c=cs1.Id,Seller_Name__c=acc1.Id,Coupon_Name__c=c1.Id,Co_Invest__c=10);
			insert coInvest;
    	
			Test.startTest();
			cs1.Coupon_Seller_Stage__c = 'Contract Signed';
			update cs1;
			Test.stopTest();
			List<Attachment> lstAtt = [select id from Attachment where ParentId =: cs1.Id];
			System.assert(lstAtt.size() == 2,'2 Attachment should be add to Coupon seller');
    	}
	}

	@isTest
	static void test_calculateCouponSeller(){
		User admin1 = EBH_TestDataFactory.createUser('System Administrator');
    	admin1.FirstName = 'Test';
    	System.runAs(admin1)
    	{
    		RecordType sellerRecordType = ApexUtil.getRecordTypeByName('Account','EBH_Seller');
			List<Account> listAcc = new List<Account>();
			for(Integer i = 0; i < 4; i++){

				Account acc = new Account(
						Name = 'Seller_'+(i+1),
						EBH_RevRollup__c = 'UK',
						EBH_PrimarySite__c= 'UK',
						EBH_DealsProgram__c='Accepted',
						RecordTypeId = sellerRecordType.Id,
                    	EBH_EmailOut__c = false
				);

				listAcc.add(acc);
			}
			insert listAcc;

			List<Contact> listCont = new List<Contact>();
			for(Integer i = 0; i < 4; i++){

				Contact cont = new Contact(
						LastName = 'SellerContact_'+(i+1),
						Email='test@test.com.invalid', 
						AccountId=listAcc[i].Id
				);

				listCont.add(cont);
			}
			insert listCont;

	    	RecordType couponRecordTypeItem = ApexUtil.getRecordTypeByName('Coupon__c',EBH_ConstantsUtility.COUPON_ITEMBASE);
	        Coupon__c c1 = new Coupon__c(MC_Whitelisted__c = true,Stage__c = 'Draft', RecordTypeID = couponRecordTypeItem.Id,Coupon_Start_Date__c = System.today(),Coupon_End_Date__c=System.today(),Contract_Language__c = 'UK',Contract_Due_Date__c = System.today()-1, Main_Coupon_Site__c='ebay.com', Couponsite_s__c = 'ebay.com');
			insert new List<Coupon__c>{c1};

			List<Coupon_Seller__c> listCS = new List<Coupon_Seller__c>();
			RecordType manhattanCouponSellerRecordType = ApexUtil.getRecordTypeByName('Coupon_Seller__c',EBH_ConstantsUtility.COUPONSELLER_MANHATTAN_RECORDTYPE);
			for(Integer i = 0; i < 4; i++){

				Coupon_Seller__c cs = new Coupon_Seller__c(Coupon__c = c1.Id,Coupon_Seller_Stage__c='Targeted',Seller_Contact__c=listCont[i].Id,EBH_CouponSellerOwner__c = UserInfo.getUserId(),Seller__c = listAcc[i].Id,RecordTypeID=manhattanCouponSellerRecordType.Id);

				listCS.add(cs);
			}
			insert listCS;
			
			Coupon_Co_Invest__c coInvest = new Coupon_Co_Invest__c(Coupon_Seller__c=listCS[0].Id,Seller_Name__c=listAcc[0].Id,Coupon_Name__c=c1.Id,Co_Invest__c=10);
			insert coInvest;
			listCS[1].Coupon_Seller_Stage__c = 'Contract Signed';
			update listCS;
			Test.startTest();
				listCS[0].Coupon_Seller_Stage__c = 'Contract Signed';
				listCS[1].Contract_Accept_Date__c = System.Now();
				update listCS;
				System.runAs(admin1)
    			{
					delete listCS[3];
				}

			Test.stopTest();
			List<Coupon__c> coupon = [select id,Sellers_Targeted2__c,Sellers_Contract_Send2__c,Sellers_Contract_Signed2__c from Coupon__c where Id =: c1.Id];
			System.assertEquals(3,coupon[0].Sellers_Targeted2__c);
			System.assertEquals(2,coupon[0].Sellers_Contract_Send2__c);
			System.assertEquals(1,coupon[0].Sellers_Contract_Signed2__c);
    	}
	}
}